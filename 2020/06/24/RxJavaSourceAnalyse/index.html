<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="../../../../lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="../../../../lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="../../../../css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="../../../../images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="../../../../images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="../../../../images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="../../../../images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Android,Android Source Analysis," />










<meta name="description" content="开篇问题:  RxJava的简单操作符如何实现的  RxJava如何完成线程切换的。多次调用subscribeOn的结果是什么，为什么 Schedulers是如何实现和管理线程的    使用Single作为表述对象  为了简述，约定俗称:  Single -&gt; 上游 SingleObserver -&gt; 下游 disposed -&gt; 丢弃 subscribe -&gt; 订阅 Di">
<meta property="og:type" content="article">
<meta property="og:title" content="RxJava源码阅读 - 基础操作符和上游线程切换">
<meta property="og:url" content="http://yoursite.com/2020/06/24/RxJavaSourceAnalyse/index.html">
<meta property="og:site_name" content="DingoDemon">
<meta property="og:description" content="开篇问题:  RxJava的简单操作符如何实现的  RxJava如何完成线程切换的。多次调用subscribeOn的结果是什么，为什么 Schedulers是如何实现和管理线程的    使用Single作为表述对象  为了简述，约定俗称:  Single -&gt; 上游 SingleObserver -&gt; 下游 disposed -&gt; 丢弃 subscribe -&gt; 订阅 Di">
<meta property="article:published_time" content="2020-06-24T14:52:28.000Z">
<meta property="article:modified_time" content="2020-06-28T09:38:11.130Z">
<meta property="article:author" content="DingoDemon">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Android Source Analysis">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/06/24/RxJavaSourceAnalyse/"/>





  <title>RxJava源码阅读 - 基础操作符和上游线程切换 | DingoDemon</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">DingoDemon</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">welcome to my zone</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="DingoDemon">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="../../../../images/Avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="DingoDemon">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">RxJava源码阅读 - 基础操作符和上游线程切换</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-24T22:52:28+08:00">
                2020-06-24
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>开篇问题:</p>
<ol>
<li>RxJava的简单操作符如何实现的 </li>
<li>RxJava如何完成线程切换的。多次调用subscribeOn的结果是什么，为什么</li>
<li>Schedulers是如何实现和管理线程的</li>
</ol>
<blockquote>
<p> 使用Single作为表述对象</p>
<p> 为了简述，约定俗称:</p>
<blockquote>
<p>Single -&gt; 上游</p>
<p>SingleObserver -&gt; 下游</p>
<p>disposed -&gt; 丢弃</p>
<p>subscribe -&gt; 订阅</p>
<p>Disposable -&gt; 订阅事件</p>
</blockquote>
<p>俗称原文会在语境中互相转换</p>
</blockquote>
<a id="more"></a>

<h2 id="just-amp-amp-subscribe"><a href="#just-amp-amp-subscribe" class="headerlink" title="just &amp;&amp; subscribe"></a>just &amp;&amp; subscribe</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Single.just(<span class="string">"1"</span>).subscribe(<span class="keyword">new</span> SingleObserver&lt;String&gt;() &#123;&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="just"><a href="#just" class="headerlink" title="just"></a>just</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CheckReturnValue</span></span><br><span class="line">   <span class="meta">@SchedulerSupport</span>(SchedulerSupport.NONE)</span><br><span class="line">   <span class="meta">@NonNull</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> &lt;<span class="meta">@NonNull</span> T&gt; <span class="function">Single&lt;T&gt; <span class="title">just</span><span class="params">(T item)</span> </span>&#123;</span><br><span class="line">       Objects.requireNonNull(item, <span class="string">"item is null"</span>);</span><br><span class="line">       <span class="keyword">return</span> RxJavaPlugins.onAssembly(<span class="keyword">new</span> SingleJust&lt;&gt;(item));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Single&lt;T&gt; <span class="title">onAssembly</span><span class="params">(@NonNull Single&lt;T&gt; source)</span> </span>&#123;</span><br><span class="line">        Function&lt;? <span class="keyword">super</span> Single, ? extends Single&gt; f = onSingleAssembly;</span><br><span class="line">        <span class="keyword">if</span> (f != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> apply(f, source);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> source;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>onSingleAssembly未特意设置的话为null，所以这里just返回的就是一个SingleJust</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleJust</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Single</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> T value;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SingleJust</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(SingleObserver&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</span><br><span class="line">        observer.onSubscribe(Disposable.disposed());</span><br><span class="line">        observer.onSuccess(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>重写了subscribeActual方法后。在方法直接调用observer中的onSubscribe，传入EmptyDisposable.INSTANCE,在onSuccess中传入value。非常简单。</p>
<h3 id="subscribe"><a href="#subscribe" class="headerlink" title="subscribe"></a>subscribe</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SchedulerSupport</span>(SchedulerSupport.NONE)</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(@NonNull SingleObserver&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</span><br><span class="line">       Objects.requireNonNull(observer, <span class="string">"observer is null"</span>);</span><br><span class="line"></span><br><span class="line">       observer = RxJavaPlugins.onSubscribe(<span class="keyword">this</span>, observer);</span><br><span class="line"></span><br><span class="line">       Objects.requireNonNull(observer, <span class="string">"The RxJavaPlugins.onSubscribe hook returned a null SingleObserver. Please check the handler provided to RxJavaPlugins.setOnSingleSubscribe for invalid null returns. Further reading: https://github.com/ReactiveX/RxJava/wiki/Plugins"</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           subscribeActual(observer);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (NullPointerException ex) &#123;</span><br><span class="line">           <span class="keyword">throw</span> ex;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">           Exceptions.throwIfFatal(ex);</span><br><span class="line">           NullPointerException npe = <span class="keyword">new</span> NullPointerException(<span class="string">"subscribeActual failed"</span>);</span><br><span class="line">           npe.initCause(ex);</span><br><span class="line">           <span class="keyword">throw</span> npe;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(@NonNull SingleObserver&lt;? <span class="keyword">super</span> T&gt; observer)</span></span>;</span><br></pre></td></tr></table></figure>

<p>实际执行的就是subscribeActual方法。</p>
<p>总结:</p>
<ol>
<li>just返回对象SingleJust，并赋值 value</li>
<li>订阅执行SingleJust的subscribeActual</li>
<li>subscribeActual中丢弃时间，调用observer.onSuccess，传入value</li>
</ol>
<h2 id="create-amp-amp-map"><a href="#create-amp-amp-map" class="headerlink" title="create &amp;&amp; map"></a>create &amp;&amp; map</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Single.create(<span class="keyword">new</span> SingleOnSubscribe&lt;Integer&gt;() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(@NonNull SingleEmitter&lt;Integer&gt; emitter)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                       emitter.onSuccess(<span class="number">1</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;).map(<span class="keyword">new</span> Function&lt;Integer, String&gt;() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(Integer integer)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                       <span class="keyword">return</span> String.valueOf(integer);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;)</span><br></pre></td></tr></table></figure>


<h3 id="create"><a href="#create" class="headerlink" title="create"></a>create</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;<span class="meta">@NonNull</span> T&gt; <span class="function">Single&lt;T&gt; <span class="title">create</span><span class="params">(@NonNull SingleOnSubscribe&lt;T&gt; source)</span> </span>&#123;</span><br><span class="line">        Objects.requireNonNull(source, <span class="string">"source is null"</span>);</span><br><span class="line">        <span class="keyword">return</span> RxJavaPlugins.onAssembly(<span class="keyword">new</span> SingleCreate&lt;&gt;(source));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>




<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SingleCreate</span><span class="params">(SingleOnSubscribe&lt;T&gt; source)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.source = source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(SingleObserver&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</span><br><span class="line">        Emitter&lt;T&gt; parent = <span class="keyword">new</span> Emitter&lt;&gt;(observer);</span><br><span class="line">        observer.onSubscribe(parent);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            source.subscribe(parent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            Exceptions.throwIfFatal(ex);</span><br><span class="line">            parent.onError(ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>static final class Emitter&lt;T&gt; extends AtomicReference&lt;Disposable&gt; implements SingleEmitter&lt;T&gt;, Disposable</code></p>
<p>构造方法中，传递下游</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Emitter(SingleObserver&lt;? <span class="keyword">super</span> T&gt; downstream) &#123;</span><br><span class="line">    <span class="keyword">this</span>.downstream = downstream;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>subscribeActual 中<br>先使用Emitter将observer包装起来，source 订阅的不再是observer，而是Emitter。</p>
<p>Emitter 继承自 AtomicReference<Disposable> 并且实现了Disposable。可以在 不改变 Observer中引用的情况下，完成自身引用的替换</Disposable></p>
<p>emitter.onSuccess(1)即</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">        <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//确保事件流没有被丢弃</span></span><br><span class="line">           <span class="keyword">if</span> (get() != DisposableHelper.DISPOSED) &#123;</span><br><span class="line">           <span class="comment">//将事件流原子置为丢弃状态，返回之前的Disposable。</span></span><br><span class="line">               Disposable d = getAndSet(DisposableHelper.DISPOSED);</span><br><span class="line">               <span class="comment">//二次检查，确认之前的Disposable状态为未被丢弃，如果被其他线程改为丢弃那么也不处理。</span></span><br><span class="line">               <span class="keyword">if</span> (d != DisposableHelper.DISPOSED) &#123;</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">                           downstream.onError(ExceptionHelper.createNullPointerException(<span class="string">"onSuccess called with a null value."</span>));</span><br><span class="line">                       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       <span class="comment">//调用observer中的onSuccess方法</span></span><br><span class="line">                           downstream.onSuccess(value);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                       <span class="keyword">if</span> (d != <span class="keyword">null</span>) &#123;</span><br><span class="line">                           d.dispose();</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<h3 id="map"><a href="#map" class="headerlink" title="map"></a>map</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(<span class="keyword">final</span> SingleObserver&lt;? <span class="keyword">super</span> R&gt; t)</span> </span>&#123;</span><br><span class="line">       source.subscribe(<span class="keyword">new</span> MapSingleObserver&lt;T, R&gt;(t, mapper));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapSingleObserver</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; <span class="keyword">implements</span> <span class="title">SingleObserver</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> SingleObserver&lt;? <span class="keyword">super</span> R&gt; t;</span><br><span class="line">       <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> T, ? extends R&gt; mapper;</span><br><span class="line"></span><br><span class="line">       MapSingleObserver(SingleObserver&lt;? <span class="keyword">super</span> R&gt; t, Function&lt;? <span class="keyword">super</span> T, ? extends R&gt; mapper) &#123;</span><br><span class="line">           <span class="keyword">this</span>.t = t;</span><br><span class="line">           <span class="keyword">this</span>.mapper = mapper;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line"> 		<span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">           R v;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               v = Objects.requireNonNull(mapper.apply(value), <span class="string">"The mapper function returned a null value."</span>);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">               Exceptions.throwIfFatal(e);</span><br><span class="line">               onError(e);</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           t.onSuccess(v);</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>map很简单，source 订阅的不再是SingleObserve ，而是包装类MapSingleObserver， 在上游调用onSuccess 的时候，真正的Observer下游会收到经过mapper转换后的结果</p>
<h2 id="subscribeOn"><a href="#subscribeOn" class="headerlink" title="subscribeOn"></a>subscribeOn</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Single&lt;T&gt; <span class="title">subscribeOn</span><span class="params">(@NonNull Scheduler scheduler)</span> </span>&#123;</span><br><span class="line">       Objects.requireNonNull(scheduler, <span class="string">"scheduler is null"</span>);</span><br><span class="line">       <span class="keyword">return</span> RxJavaPlugins.onAssembly(<span class="keyword">new</span> SingleSubscribeOn&lt;&gt;(<span class="keyword">this</span>, scheduler));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(<span class="keyword">final</span> SingleObserver&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> SubscribeOnObserver&lt;T&gt; parent = <span class="keyword">new</span> SubscribeOnObserver&lt;&gt;(observer, source);</span><br><span class="line">       observer.onSubscribe(parent);</span><br><span class="line"></span><br><span class="line">       Disposable f = scheduler.scheduleDirect(parent);</span><br><span class="line"></span><br><span class="line">       parent.task.replace(f);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>同样的构造一个SubscribeOnObserver类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SubscribeOnObserver</span>&lt;<span class="title">T</span>&gt;  <span class="keyword">extends</span> <span class="title">AtomicReference</span>&lt;<span class="title">Disposable</span>&gt;  <span class="keyword">implements</span> <span class="title">SingleObserver</span>&lt;<span class="title">T</span>&gt;, <span class="title">Disposable</span>, <span class="title">Runnable</span></span></span><br></pre></td></tr></table></figure>

<p>SubscribeOnObserver 构造方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SubscribeOnObserver(SingleObserver&lt;? <span class="keyword">super</span> T&gt; actual, SingleSource&lt;? extends T&gt; source) &#123;</span><br><span class="line">         <span class="keyword">this</span>.downstream = actual;</span><br><span class="line">         <span class="keyword">this</span>.source = source;</span><br><span class="line">         <span class="keyword">this</span>.task = <span class="keyword">new</span> SequentialDisposable();</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            source.subscribe(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>通过后续代码阅读，可以得到结论。scheduler根据设定的线程(new,io,computation等)，在run方法中，进行订阅。然后，将执行线程中订阅成功后的事件，放入容器中，丢弃事件流的时候，容器中的事件流也会被丢弃。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispose</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           DisposableHelper.dispose(<span class="keyword">this</span>);</span><br><span class="line">           task.dispose();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>总的来讲<br>SingleSubscribeOn中subscribeActual的过程很简单，也就是切换到指定线程 -&gt; 订阅。所以，从流程的角度来讲:</p>
<p>当多次调用subscribeOn方法时，从后往前，会切换到第一次调用时所指定的线程。所以，从代码层面来看。只有第一次指定subscribeOn的线程有效。</p>
<p>下文会详细分析这一流程</p>
<h3 id="scheduler-scheduleDirect"><a href="#scheduler-scheduleDirect" class="headerlink" title="scheduler.scheduleDirect"></a>scheduler.scheduleDirect</h3><p>Work是一个可被丢弃的，可以被安排执行runnable的执行者。通过schedule方法执行runnable，并返回Disposable</p>
<p><code>public abstract Disposable schedule(@NonNull Runnable run, long delay, @NonNull TimeUnit unit);</code></p>
<p>而Scheduler调度管理Work，各种Scheduler重写createWorker方法，创建不同的Work<br><code>public abstract Worker createWorker();</code></p>
<blockquote>
<p>work先以newThread为例，即Schedulers.newThread(),创建一个新线程来执行任务</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Disposable <span class="title">scheduleDirect</span><span class="params">(@NonNull Runnable run, <span class="keyword">long</span> delay, @NonNull TimeUnit unit)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Worker w = createWorker();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Runnable decoratedRun = RxJavaPlugins.onSchedule(run);</span><br><span class="line"></span><br><span class="line">    DisposeTask task = <span class="keyword">new</span> DisposeTask(decoratedRun, w);</span><br><span class="line"></span><br><span class="line">    w.schedule(task, delay, unit);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> task;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="创建执行者Work"><a href="#创建执行者Work" class="headerlink" title="创建执行者Work"></a>创建执行者Work</h4><p>createWorker是一个抽象方法，找到类NewThreadScheduler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> NewThreadWorker(threadFactory);</span><br></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewThreadWorker</span> <span class="keyword">extends</span> <span class="title">Scheduler</span>.<span class="title">Worker</span> <span class="keyword">implements</span> <span class="title">Disposable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService executor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">boolean</span> disposed;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NewThreadWorker</span><span class="params">(ThreadFactory threadFactory)</span> </span>&#123;</span><br><span class="line">        executor = SchedulerPoolFactory.create(threadFactory);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//略...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>work执行runnable的方法为schedule</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NonNull</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Disposable <span class="title">schedule</span><span class="params">(@NonNull <span class="keyword">final</span> Runnable action, <span class="keyword">long</span> delayTime, @NonNull TimeUnit unit)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (disposed) &#123;</span><br><span class="line">           <span class="keyword">return</span> EmptyDisposable.INSTANCE;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> scheduleActual(action, delayTime, unit, <span class="keyword">null</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NonNull</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ScheduledRunnable <span class="title">scheduleActual</span><span class="params">(<span class="keyword">final</span> Runnable run, <span class="keyword">long</span> delayTime, @NonNull TimeUnit unit, @Nullable DisposableContainer parent)</span> </span>&#123;</span><br><span class="line">      Runnable decoratedRun = RxJavaPlugins.onSchedule(run);</span><br><span class="line">      ScheduledRunnable sr = <span class="keyword">new</span> ScheduledRunnable(decoratedRun, parent);</span><br><span class="line">      Future&lt;?&gt; f;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (delayTime &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">              f = executor.submit((Callable&lt;Object&gt;)sr);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              f = executor.schedule((Callable&lt;Object&gt;)sr, delayTime, unit);</span><br><span class="line">          &#125;</span><br><span class="line">          sr.setFuture(f);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (RejectedExecutionException ex) &#123;</span><br><span class="line">          <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">              parent.remove(sr);</span><br><span class="line">          &#125;</span><br><span class="line">          RxJavaPlugins.onError(ex);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> sr;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到实际上是将runnable包装为Future交给线程池去进行操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispose</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!disposed) &#123;</span><br><span class="line">          disposed = <span class="keyword">true</span>;</span><br><span class="line">          executor.shutdownNow();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>丢弃事件直接强制关闭executor</p>
<h4 id="DisposeTask"><a href="#DisposeTask" class="headerlink" title="DisposeTask"></a>DisposeTask</h4><p>DisposeTask是一个可被丢弃的runnable</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DisposeTask</span> <span class="keyword">implements</span> <span class="title">Disposable</span>, <span class="title">Runnable</span>, <span class="title">SchedulerRunnableIntrospection</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">        DisposeTask(<span class="meta">@NonNull</span> Runnable decoratedRun, <span class="meta">@NonNull</span> Worker w) &#123;</span><br><span class="line">            <span class="keyword">this</span>.decoratedRun = decoratedRun;</span><br><span class="line">            <span class="keyword">this</span>.w = w;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            runner = Thread.currentThread();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                decoratedRun.run();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                dispose();</span><br><span class="line">                runner = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>他在run方法中，实际执行的是传入的runnable。</p>
<h3 id="线程切换内部总结"><a href="#线程切换内部总结" class="headerlink" title="线程切换内部总结"></a>线程切换内部总结</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Disposable f = scheduler.scheduleDirect(parent);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Disposable <span class="title">scheduleDirect</span><span class="params">(@NonNull Runnable run)</span> </span>&#123;  <span class="keyword">return</span> scheduleDirect(run, <span class="number">0L</span>, TimeUnit.NANOSECONDS);&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>根据subscribeOn方法参数，创建Work。</li>
<li>创建一个可被丢弃的Runnable，即DisposeTask。其run方法中执行订阅。并在finally中，切断事件(Single发送一次数据后丢弃事件)</li>
<li>让Work去执行DisposeTask完成订阅。</li>
<li>原来的上游运行在Work中了，执行原来上游中的subscribeActual进行数据发送</li>
</ol>
<h2 id="Scheduler类"><a href="#Scheduler类" class="headerlink" title="Scheduler类"></a>Scheduler类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Scheduler SINGLE;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Scheduler COMPUTATION;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Scheduler IO;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Scheduler TRAMPOLINE;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Scheduler NEW_THREAD;</span><br></pre></td></tr></table></figure>

<p>以NewThread,ComputationScheduler, IoScheduler来看</p>
<h4 id="NewThreadScheduler"><a href="#NewThreadScheduler" class="headerlink" title="NewThreadScheduler"></a>NewThreadScheduler</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NewThreadWorker</span><span class="params">(ThreadFactory threadFactory)</span> </span>&#123;</span><br><span class="line">      executor = SchedulerPoolFactory.create(threadFactory);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Worker <span class="title">createWorker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> NewThreadWorker(threadFactory);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NewThreadWorker</span><span class="params">(ThreadFactory threadFactory)</span> </span>&#123;</span><br><span class="line">      executor = SchedulerPoolFactory.create(threadFactory);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>


<h4 id="ComputationScheduler"><a href="#ComputationScheduler" class="headerlink" title="ComputationScheduler"></a>ComputationScheduler</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ComputationScheduler</span><span class="params">(ThreadFactory threadFactory)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.threadFactory = threadFactory;</span><br><span class="line">      <span class="keyword">this</span>.pool = <span class="keyword">new</span> AtomicReference&lt;&gt;(NONE);</span><br><span class="line">      start();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       FixedSchedulerPool update = <span class="keyword">new</span> FixedSchedulerPool(MAX_THREADS, threadFactory);</span><br><span class="line">       <span class="comment">//替换pool引用</span></span><br><span class="line">       <span class="keyword">if</span> (!pool.compareAndSet(NONE, update)) &#123;</span><br><span class="line">           update.shutdown();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Worker <span class="title">createWorker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">//从pool里拿到work PoolWorker</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> EventLoopWorker(pool.get().getEventLoop());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="IoScheduler"><a href="#IoScheduler" class="headerlink" title="IoScheduler"></a>IoScheduler</h4><p>跟Computation类似，替换pool，从pool中拿</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">IoScheduler</span><span class="params">(ThreadFactory threadFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.threadFactory = threadFactory;</span><br><span class="line">        <span class="keyword">this</span>.pool = <span class="keyword">new</span> AtomicReference&lt;&gt;(NONE);</span><br><span class="line">        start();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      CachedWorkerPool update = <span class="keyword">new</span> CachedWorkerPool(KEEP_ALIVE_TIME, KEEP_ALIVE_UNIT, threadFactory);</span><br><span class="line">      <span class="keyword">if</span> (!pool.compareAndSet(NONE, update)) &#123;</span><br><span class="line">          update.shutdown();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Worker <span class="title">createWorker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> EventLoopWorker(pool.get());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="FixedSchedulerPool-amp-amp-CachedWorkerPool"><a href="#FixedSchedulerPool-amp-amp-CachedWorkerPool" class="headerlink" title="FixedSchedulerPool &amp;&amp; CachedWorkerPool"></a>FixedSchedulerPool &amp;&amp; CachedWorkerPool</h3><h4 id="FixedSchedulerPool"><a href="#FixedSchedulerPool" class="headerlink" title="FixedSchedulerPool"></a>FixedSchedulerPool</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FixedSchedulerPool(<span class="keyword">int</span> maxThreads, ThreadFactory threadFactory) &#123;</span><br><span class="line">         <span class="comment">// initialize event loops</span></span><br><span class="line">         <span class="keyword">this</span>.cores = maxThreads;</span><br><span class="line">         <span class="keyword">this</span>.eventLoops = <span class="keyword">new</span> PoolWorker[maxThreads];</span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; maxThreads; i++) &#123;</span><br><span class="line">             <span class="keyword">this</span>.eventLoops[i] = <span class="keyword">new</span> PoolWorker(threadFactory);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>其中maxThreads为cpu核心数,构建一个大小为核心线程数的PoolWorker数组，PoolWorker是NewThreadWorker的子类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PoolWorker</span> <span class="keyword">extends</span> <span class="title">NewThreadWorker</span> </span>&#123;</span><br><span class="line">       PoolWorker(ThreadFactory threadFactory) &#123;</span><br><span class="line">           <span class="keyword">super</span>(threadFactory);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>而NewThreadWorker在构造方法中通过Executors创建了一个核心线程数大小为1的ScheduledExecutorService。</p>
<p>所以，FixedSchedulerPool会构建一个等同于CPU线程数的ScheduledExecutorService数组，来了任务后，从pool里面get</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PoolWorker <span class="title">getEventLoop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> c = cores;</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> SHUTDOWN_WORKER;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// simple round robin, improvements to come</span></span><br><span class="line">            <span class="keyword">return</span> eventLoops[(<span class="keyword">int</span>)(n++ % c)];</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h4 id="CachedWorkerPool"><a href="#CachedWorkerPool" class="headerlink" title="CachedWorkerPool"></a>CachedWorkerPool</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CachedWorkerPool(<span class="keyword">long</span> keepAliveTime, TimeUnit unit, ThreadFactory threadFactory) &#123;</span><br><span class="line">         <span class="keyword">this</span>.keepAliveTime = unit != <span class="keyword">null</span> ? unit.toNanos(keepAliveTime) : <span class="number">0L</span>;</span><br><span class="line">         <span class="keyword">this</span>.expiringWorkerQueue = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;&gt;();</span><br><span class="line">         <span class="keyword">this</span>.allWorkers = <span class="keyword">new</span> CompositeDisposable();</span><br><span class="line">         <span class="keyword">this</span>.threadFactory = threadFactory;</span><br><span class="line"></span><br><span class="line">         ScheduledExecutorService evictor = <span class="keyword">null</span>;</span><br><span class="line">         Future&lt;?&gt; task = <span class="keyword">null</span>;</span><br><span class="line">         <span class="keyword">if</span> (unit != <span class="keyword">null</span>) &#123;</span><br><span class="line">             evictor = Executors.newScheduledThreadPool(<span class="number">1</span>, EVICTOR_THREAD_FACTORY);</span><br><span class="line">             task = evictor.scheduleWithFixedDelay(<span class="keyword">this</span>, <span class="keyword">this</span>.keepAliveTime, <span class="keyword">this</span>.keepAliveTime, TimeUnit.NANOSECONDS);</span><br><span class="line">         &#125;</span><br><span class="line">         evictorService = evictor;</span><br><span class="line">         evictorTask = task;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>evictorService会执行一个定时60s的任务，检查ThreadWorker是否过期。如果过期了的话就将其从线程队列中移除。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ThreadWorker <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (allWorkers.isDisposed()) &#123;</span><br><span class="line">            <span class="keyword">return</span> SHUTDOWN_THREAD_WORKER;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (!expiringWorkerQueue.isEmpty()) &#123;</span><br><span class="line">            ThreadWorker threadWorker = expiringWorkerQueue.poll();</span><br><span class="line">            <span class="keyword">if</span> (threadWorker != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> threadWorker;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// No cached worker found, so create a new one.</span></span><br><span class="line">        ThreadWorker w = <span class="keyword">new</span> ThreadWorker(threadFactory);</span><br><span class="line">        allWorkers.add(w);</span><br><span class="line">        <span class="keyword">return</span> w;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>获取线程的时候，先会去检查队列,如果有的话，就拿出来。没有的话则创建一个并放入队列</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="../../../../tags/Android/" rel="tag"># Android</a>
          
            <a href="../../../../tags/Android-Source-Analysis/" rel="tag"># Android Source Analysis</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="../../18/TouchEventSourceCode/" rel="next" title="Touch事件 流程分析">
                <i class="fa fa-chevron-left"></i> Touch事件 流程分析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="../../../07/02/Choreographer%E5%88%86%E6%9E%90/" rel="prev" title="Choreographer源码阅读">
                Choreographer源码阅读 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="../../../../images/Avatar.png"
                alt="DingoDemon" />
            
              <p class="site-author-name" itemprop="name">DingoDemon</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="../../../../archives">
              
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="../../../../tags/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="mailto:wangdingyusg@163.com" target="_blank" title="Email">
                      
                        <i class="fa fa-fw fa-globe"></i>Email</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/DingoDemon" target="_blank" title="github">
                      
                        <i class="fa fa-fw fa-globe"></i>github</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#just-amp-amp-subscribe"><span class="nav-number">1.</span> <span class="nav-text">just &amp;&amp; subscribe</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#just"><span class="nav-number">1.1.</span> <span class="nav-text">just</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#subscribe"><span class="nav-number">1.2.</span> <span class="nav-text">subscribe</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#create-amp-amp-map"><span class="nav-number">2.</span> <span class="nav-text">create &amp;&amp; map</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#create"><span class="nav-number">2.1.</span> <span class="nav-text">create</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#map"><span class="nav-number">2.2.</span> <span class="nav-text">map</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#subscribeOn"><span class="nav-number">3.</span> <span class="nav-text">subscribeOn</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#scheduler-scheduleDirect"><span class="nav-number">3.1.</span> <span class="nav-text">scheduler.scheduleDirect</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建执行者Work"><span class="nav-number">3.1.1.</span> <span class="nav-text">创建执行者Work</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DisposeTask"><span class="nav-number">3.1.2.</span> <span class="nav-text">DisposeTask</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#线程切换内部总结"><span class="nav-number">3.2.</span> <span class="nav-text">线程切换内部总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Scheduler类"><span class="nav-number">4.</span> <span class="nav-text">Scheduler类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#NewThreadScheduler"><span class="nav-number">4.0.1.</span> <span class="nav-text">NewThreadScheduler</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ComputationScheduler"><span class="nav-number">4.0.2.</span> <span class="nav-text">ComputationScheduler</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IoScheduler"><span class="nav-number">4.0.3.</span> <span class="nav-text">IoScheduler</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FixedSchedulerPool-amp-amp-CachedWorkerPool"><span class="nav-number">4.1.</span> <span class="nav-text">FixedSchedulerPool &amp;&amp; CachedWorkerPool</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#FixedSchedulerPool"><span class="nav-number">4.1.1.</span> <span class="nav-text">FixedSchedulerPool</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CachedWorkerPool"><span class="nav-number">4.1.2.</span> <span class="nav-text">CachedWorkerPool</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">DingoDemon</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="../../../../lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="../../../../lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="../../../../lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="../../../../lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../../../lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../../../lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="../../../../js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="../../../../js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="../../../../js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="../../../../js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="../../../../js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="../../../../js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="../../../../js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'r43AXdYACvdhTYR8Toy6Q9fc-gzGzoHsz',
        appKey: '0xriQo9vWWIjN3N4V2u1PqL6',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  

</body>
</html>
